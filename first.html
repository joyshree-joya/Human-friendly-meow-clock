<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Human Friendly Meow Clock</title>
  <style>
    :root{
      --pageBg:#f8d2d0;          /* warm background like your cards */
      --cardBg:#fbf2e6;
      --ink:#3a2416;
      --ring:#9a5a2c;
      --ringShadow:#5b2d14;

      --accentCyan:#11c7c7;
      --accentOrange:#f57c1f;
      --softShadow: 10px 10px 0 var(--ringShadow);
    }

    html,body{
      height:100%;
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: var(--pageBg);
      color: var(--ink);
    }

    /* ----- Banner (optional; you asked earlier) ----- */
    .banner{
      width: min(1100px, 94vw);
      margin: 18px auto 8px;
      background: #FEF9EA;
      border: 1px solid rgba(0,0,0,.10);
      box-shadow: 6px 6px 0 rgba(0,0,0,.10);
      padding: 10px 16px 12px;
      box-sizing: border-box;
    }
    .banner-inner{
      display:grid;
      grid-template-columns:auto 1fr auto;
      align-items:center;
      gap:14px;
    }
    .banner-icon{
      font-size: clamp(26px, 3.2vw, 42px);
      line-height:1;
      user-select:none;
      filter: drop-shadow(0 2px 0 rgba(0,0,0,.10));
    }
    .banner-text{ text-align:center; }
    .banner-title{
      font-family: Impact, "Arial Black", "Anton", sans-serif;
      font-size: clamp(22px, 3.8vw, 54px);
      font-weight:900;
      letter-spacing: 1px;
      color: var(--accentOrange);
      -webkit-text-stroke: 3px #753B12;
      text-shadow: 2px 2px 0 #753B12, 3px 3px 0 rgba(0,0,0,.12);
      transform: skewX(-10deg);
      line-height: 1.05;
      white-space: nowrap;
    }
    .banner-subtitle{
      margin-top: 3px;
      font-family: Georgia, "Times New Roman", serif;
      font-style: italic;
      color: #CB894C;
      font-size: clamp(12px, 1.4vw, 18px);
    }

    /* ----- Main layout ----- */
  .layout{
  width: 100vw;                 /* fill the screen */
  max-width: 1600px;            /* keeps it from going insane on huge screens */
  margin: 14px auto 28px;
  padding: 0 52px;              /* distance from screen edges (tweak) */
  box-sizing: border-box;

  display: grid;
  grid-template-columns: 360px 1fr 420px;  /* left | center | right */
  align-items: start;
  column-gap: 28px;
}

.side{
  display:flex;
  flex-direction:column;
  gap: 16px;
}

.side-left{ justify-self: start; }  /* push to far left */
.side-right{ justify-self: end; }   /* push to far right */

.center{
  justify-self: center;             /* keep clock centered */
}

/* Keep your existing mobile stacking */
@media (max-width: 980px){
  .layout{
    grid-template-columns: 1fr;
    row-gap: 18px;
    padding: 0 16px;
  }
  .side-left, .side-right, .center{ justify-self: center; }
}

    /* ----- Card style (straight, with brown border + shadow) ----- */
    .card{
      background: var(--cardBg);
      border: 3px solid var(--ink);
      border-radius: 12px;
      box-shadow: var(--softShadow);
      padding: 14px 16px;
      box-sizing:border-box;
    }

    .label{
      font-size: 12px;
      letter-spacing: .8px;
      text-transform: uppercase;
      opacity: .75;
      margin-bottom: 6px;
    }

    .bigTime{
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      font-weight: 900;
      font-size: 34px;
      color: var(--accentCyan);
      line-height: 1.1;
    }

    .alarmText{
      font-family: Impact, "Arial Black", "Anton", sans-serif;
      font-weight: 900;
      font-size: 28px;
      color: var(--accentOrange);
      -webkit-text-stroke: 1px #753B12;
      text-shadow: 1px 1px 0 rgba(0,0,0,.10);
      line-height: 1.1;
    }

    /* ----- Clock ----- */
    .clock{
      width: min(520px, 70vw);
      aspect-ratio: 1 / 1;
      border-radius: 50%;
      background: #f6f2ea;
      border: 12px solid var(--ring);
      box-shadow: 10px 10px 0 var(--ringShadow), 0 18px 40px rgba(0,0,0,.10);
      position: relative;
      overflow: hidden;
      user-select:none;
    }
    /* inner rim */
    .clock::after{
      content:"";
      position:absolute;
      inset: 14px;
      border-radius:50%;
      border: 4px solid rgba(0,0,0,.10);
      pointer-events:none;
      z-index: 1;
    }

    .tick{
      position:absolute;
      left:50%;
      top:50%;
      width: 6px;
      height: 10px;
      border-radius: 10px;
      background: #5b341a;
      z-index: 2;
      transform-origin: 50% 50%;
      opacity:.95;
    }
    .tick.big{
      width: 10px;
      height: 16px;
    }

    /* optional cat watermark inside clock */
    .cat{
      position:absolute;
      left:50%;
      top:50%;
      width: 110%;
      height: 110%;
      transform: translate(-50%,-50%);
      object-fit: contain;
      opacity: .22;              /* change this to 0.6 if you want it stronger */
      z-index: 2;
      pointer-events:none;
      filter: contrast(1.1);
    }

    .hand{
      position:absolute;
      left:50%;
      top:50%;
      transform-origin: 50% 92%;
      transform: translate(-50%, -92%) rotate(0deg);
      border-radius: 999px;
      z-index: 5;
    }

    .hand.hour{
      width: 12px;
      height: 155px;
      background: #5b341a;
      z-index: 6;
    }

    .hand.minute{
      width: 8px;
      height: 220px;
      background: #ff8a1b;
      z-index: 7;
    }

    .hand.second{
      width: 4px;
      height: 235px;
      background: #ff2b2b;
      z-index: 8;
    }

    /* Alarm hand (set by globe) */
    .hand.alarm{
      width: 7px;
      height: 200px;
      background: rgba(91,52,26,.85);
      z-index: 6;               /* above hour, under minute/second */
      display:none;             /* shown only when alarm is set */
      box-shadow: 0 6px 14px rgba(0,0,0,.08);
    }

    .centerDot{
      position:absolute;
      left:50%;
      top:50%;
      width: 18px;
      height: 18px;
      transform: translate(-50%,-50%);
      border-radius: 50%;
      background: #ff8a1b;
      border: 4px solid #5b341a;
      z-index: 10;
    }

    /* ----- Spin card ----- */
    .spinTitle{
      font-family: Impact, "Arial Black", "Anton", sans-serif;
      text-align:center;
      font-size: 24px;
      color: var(--accentOrange);
      -webkit-text-stroke: 1px #753B12;
      margin-bottom: 4px;
    }
    .spinSub{
      text-align:center;
      font-family: Georgia, "Times New Roman", serif;
      font-style: italic;
      opacity: .8;
      margin-bottom: 12px;
    }

    .globeStage{
      display:grid;
      place-items:center;
      gap: 10px;
      padding: 6px 0 10px;
    }

    /* static arrow above globe */
    .arrowBox{
      width: 36px;
      height: 28px;
      display:grid;
      place-items:center;
      background: #9ad1ff;
      border: 2px solid rgba(0,0,0,.18);
      border-radius: 8px;
      font-size: 18px;
      user-select:none;
    }

    .globeWrap{
      width: 210px;
      height: 210px; /* ~1.15x from 180ish */
      border-radius: 50%;
      border: 4px solid #5b341a;
      box-shadow: 8px 8px 0 rgba(0,0,0,.12);
      position: relative;
      cursor: grab;
      user-select:none;
      touch-action: none;
      background: transparent;
    }
    .globeWrap:active{ cursor: grabbing; }

    /* The globe itself */
    .globe{
      position:absolute;
      inset: 0;
      border-radius:50%;
      background: radial-gradient(circle at 30% 28%, #54e3a7 0%, #2fb8a6 32%, #2b7bff 62%, #1a4ccf 100%);
      overflow:hidden;
    }
    /* fake "continents" blobs */
    .globe::before{
      content:"";
      position:absolute;
      inset: 22%;
      border-radius: 40% 60% 55% 45% / 55% 40% 60% 45%;
      background: rgba(0,0,0,.12);
      filter: blur(0.2px);
      transform: rotate(-12deg);
    }
    .globe::after{
      content:"";
      position:absolute;
      left: 22%;
      top: 55%;
      width: 44%;
      height: 30%;
      border-radius: 60% 40% 50% 50% / 45% 60% 40% 55%;
      background: rgba(0,0,0,.10);
      transform: rotate(18deg);
    }

    /* Marker dot at top edge that rotates WITH globe */
    .mark{
      position:absolute;
      left:50%;
      top: -6px;
      transform: translateX(-50%);
      width: 16px;
      height: 16px;
      border-radius: 50%;
      background: #ff2b2b;
      border: 3px solid #5b341a;
      box-shadow: 0 6px 0 rgba(0,0,0,.10);
      z-index: 5;
    }

    .legend{
      display:grid;
      gap: 6px;
      font-size: 13px;
      margin-top: 6px;
    }
    .legendRow{
      display:flex;
      gap: 8px;
      align-items:center;
      justify-content:center;
      opacity:.9;
    }
    .legendRow span{
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
    }

    .rotationLine{
      text-align:center;
      margin-top: 10px;
      font-weight: 800;
      color: #1aa8a8;
    }
    .rotationLine span{
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
    }

    /* ----- Alarm overlay + buttons ----- */
    .overlay{
      position:fixed;
      inset:0;
      background: rgba(0,0,0,.42);
      display:none;
      place-items:center;
      z-index:3000;
    }
    .overlay.show{ display:grid; }

   /* Alarm overlay popup = same as your cards */
<!-- .overlay .alarmBox{
     width: min(700px, 94vw);  
  max-height: 85vh;      /* important */
  overflow: auto;    
  background: var(--cardBg);
  border: 3px solid var(--ink);
  border-radius: 12px;
  box-shadow: var(--softShadow);
  padding: 16px;
} -->
/* Normal ringing: small popup */
.overlay .alarmBox{
  width: min(1000px, 95vw);
  height: auto;
}

/* Challenge mode: full page, no scrolling */
.overlay .alarmBox.challengeMode{
  width: 96vw;
  height: 92vh;        /* full page feel */
  overflow: hidden;    /* no scrollbars */
  display: grid;
  grid-template-rows: auto 1fr auto auto; 
  gap: 12px;
}


    .alarmTitle{
      margin:0 0 10px;
      font-size: 20px;
      font-weight: 900;
    }
.globeCat{
  position:absolute;
  inset: 0;
  width: 100%;
  height: 100%;
  object-fit: contain;
  z-index: 4;           /* above globe, under marker */
  pointer-events: none; /* doesn't block dragging */
  transform: scale(1.05); /* slight boost so it fills nicely */
}

    .buttonsRow{
  display:grid;
  grid-template-columns: 1fr 1fr;
  gap: 12px;
  align-items:center;
  justify-items:center;

  /* REMOVE these if you have them */
  height: auto;          /* was 84px */
  overflow: visible;     /* was hidden */

  padding: 14px;         /* add padding so it looks good */
  border-radius: 14px;
  border: 2px solid rgba(0,0,0,.18);
  background: rgba(255,255,255,.55);
}

/* --- Challenge card inside alarm popup --- */
.challengeCard{
  margin-top: 14px;
}

/* inner headline box (lighter shadow) */
.innerHeadline{
  background: rgba(255,255,255,.60);
  border: 2px solid rgba(58,36,22,.55);
  border-radius: 12px;
  box-shadow: 6px 6px 0 rgba(91,45,20,.55);
  padding: 10px 12px;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 10px;
}

.hImg{
  width: 150px;
  height: 150px;
  object-fit: contain;
  flex: 0 0 auto;
}

.hText{
  font-family: Impact, "Arial Black", "Anton", sans-serif;
  font-weight: 900;
  font-size: 24px;
  line-height: 1.05;
  text-align: center;
  color: var(--accentOrange);
  -webkit-text-stroke: 1px #753B12;
  text-shadow: 2px 2px 0 rgba(0,0,0,.10);
}

.codeImg{
  display: block;
  width: 100%;
  max-width: 820px;
  margin: 12px auto 10px;
  border-radius: 10px;
  border: 2px solid rgba(0,0,0,.12);
  box-shadow: 6px 6px 0 rgba(91,45,20,.35);
}

/* answer inputs + submit */
.answerRow{
  display: flex;
  gap: 10px;
  justify-content: center;
  align-items: center;
  flex-wrap: wrap;
  margin-top: 6px;
}

.ansInput{
  width: 90px;
  padding: 12px 12px;
  border-radius: 12px;
  border: 3px solid var(--ink);
  background: #fff;
  font-weight: 900;
  font-size: 16px;
  box-shadow: 6px 6px 0 var(--ringShadow);
  outline: none;
}

.ansBtn{
  border: 3px solid var(--ink);
  background: #fff;
  box-shadow: 6px 6px 0 var(--ringShadow);
  transition: transform .08s ease, box-shadow .08s ease;
  padding: 12px 16px;
  font-weight: 900;
}

.ansBtn:hover{
  transform: translate(-1px,-1px);
  box-shadow: 8px 8px 0 var(--ringShadow);
}

.ansBtn:active{
  transform: translate(2px,2px);
  box-shadow: 3px 3px 0 var(--ringShadow);
}

/* feedback card */
.feedbackCard{
  margin-top: 12px;
  display: flex;
  gap: 12px;
  align-items: center;
}

.fbImg{
  width: 150px;
  height: 150px;
  object-fit: contain;
  flex: 0 0 auto;
}

.fbText{
  font-weight: 900;
  font-size: 18px;
}

.hidden{ display:none; }

    button{
      padding: 12px 14px;
      border-radius: 14px;
      border: 2px solid rgba(0,0,0,.18);
      background:#fff;
      font-weight: 900;
      cursor:pointer;
      user-select:none;
    }
    .buttonsRow{
  height:auto;
  overflow:visible;
  padding:14px;
}

    .overlay .buttonsRow{
  background: rgba(255,255,255,.55);
  border: 2px solid rgba(0,0,0,.18);
  border-radius: 12px;
  box-shadow: inset 0 0 0 2px rgba(0,0,0,.06);
}

#stopBtn, #snoozeBtn{
  border: 3px solid var(--ink);
  background: #fff;
  box-shadow: 6px 6px 0 var(--ringShadow);
  transition: transform 0.08s ease, box-shadow 0.08s ease;
}

#stopBtn:hover, #snoozeBtn:hover{
  transform: translate(-1px, -1px);
  box-shadow: 8px 8px 0 var(--ringShadow);
}

#stopBtn:active, #snoozeBtn:active{
  transform: translate(2px, 2px);
  box-shadow: 3px 3px 0 var(--ringShadow);
}

    button:active{ transform: translateY(1px); }

    #stopBtn{ position:relative; z-index:3101; }

    /* Snooze is global and runs anywhere */
    #snoozeBtn{
      position: fixed;
      z-index: 5000;
      display:none;
      white-space:nowrap;
    }
  </style>
</head>

<body>
  <div class="banner">
    <div class="banner-inner">
      <div class="banner-icon">üò∫</div>
      <div class="banner-text">
        <div class="banner-title">HUMAN FRIENDLY MEOW CLOCK</div>
        <div class="banner-subtitle">The world's worst (best?) alarm clock</div>
      </div>
      <div class="banner-icon">‚è∞</div>
    </div>
  </div>

  <div class="layout">
    <!-- LEFT: 2 cards -->
    <div class="side side-left">
      <div class="card">
        <div class="label">CURRENT TIME (FOR HUMANS WHO CAN'T READ ANALOG üò∫)</div>
        <div class="bigTime" id="digitalNow">--:--:-- --</div>
      </div>

      <div class="card">
        <div class="label">‚è∞ ALARM STATUS</div>
        <div class="alarmText" id="alarmStatus">ALARM NOT SET YET üò∫</div>
      </div>
    </div>

    <!-- CENTER: Clock -->
    <div class="center">
      <div class="clock" id="clock">
        <!-- optional watermark cat -->
        <img class="cat" src="cat.jpg" alt="cat" />

        <!-- ticks injected by JS -->
        <div class="hand alarm" id="alarmHand"></div>
        <div class="hand hour" id="hourHand"></div>
        <div class="hand minute" id="minuteHand"></div>
        <div class="hand second" id="secondHand"></div>
        <div class="centerDot"></div>
      </div>
    </div>

    <!-- RIGHT: Spin Earth card -->
    <div class="side side-right">
      <div class="card">
        <div class="spinTitle">üåé SPIN THE EARTH TO SET ALARM üåé</div>
        <div class="spinSub">(Because sliders are too easy üò∫)</div>

        <div class="globeStage">
          <div class="arrowBox">‚¨ÜÔ∏è</div>

          <!-- globeWrap rotates (globe + mark rotate together) -->
          <div class="globeWrap" id="globeWrap" aria-label="Spin the globe to set alarm">
             <img class="globeCat" src="globecat.jpg" alt="cat hugging globe" />
            <div class="globe"></div>
            <div class="mark"></div>
          </div>

          <div class="legend">
            <div class="legendRow">üîÅ <span>0.25¬∞ rotation</span> = <span>1 minute</span></div>
            <div class="legendRow">üåç <span>15¬∞ rotation</span> = <span>1 hour</span></div>
          </div>

          <div class="rotationLine">
            Total rotation: <span id="rotText">0.0¬∞</span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Alarm overlay -->
  <div class="overlay" id="overlay">
    <div class="alarmBox">
     <h2 class="alarmTitle">ALARM RINGING üîî</h2>

<!-- STEP 1: only buttons -->
<div id="alarmStepButtons">
  <div class="buttonsRow" id="buttonsRow">
    <div id="snoozeAnchor"></div>
    <button id="stopBtn">STOP</button>
  </div>
</div>

<!-- STEP 2: coding challenge (hidden at first) -->
<div id="alarmStepChallenge" class="hidden">
  <div class="card challengeCard" id="challengeCard">
    <div class="innerHeadline">
      <img class="hImg" src="flowercat.png" alt="helper left" />
      <div class="hText">NOW I WILL HELP YOU WAKE UP BETTER MEOW</div>
      <img class="hImg" src="smilecat.png" alt="helper right" />
    </div>

    <img class="codeImg" src="codec.png" alt="code question" />

    <div class="answerRow">
     <input id="ansA" class="ansInput"
  type="text" inputmode="numeric"
  autocomplete="new-password" autocorrect="off" autocapitalize="off" spellcheck="false"
  name="ansA_nope"
  placeholder="a" />

<input id="ansB" class="ansInput"
  type="text" inputmode="numeric"
  autocomplete="new-password" autocorrect="off" autocapitalize="off" spellcheck="false"
  name="ansB_nope"
  placeholder="b" />

      <button id="submitAns" class="ansBtn">SUBMIT</button>
    </div>

    <div class="card feedbackCard hidden" id="feedbackCard">
      <img id="feedbackImg" class="fbImg" src="worriedcat.png"  />
      <div id="feedbackText" class="fbText"></div>
    </div>
  </div>
</div>

    </div>
  </div>

  <!-- Global snooze button -->
  <button id="snoozeBtn">SNOOZE (5 min)</button>

  <script>
    // ---------- Helpers ----------
    const pad2 = (n) => String(n).padStart(2, "0");

    function format12h(d){
      let h = d.getHours();
      const m = d.getMinutes();
      const s = d.getSeconds();
      const ampm = h >= 12 ? "PM" : "AM";
      h = h % 12; if (h === 0) h = 12;
      return `${pad2(h)}:${pad2(m)}:${pad2(s)} ${ampm}`;
    }

    function formatAlarm12h(d){
      let h = d.getHours();
      const m = d.getMinutes();
      const ampm = h >= 12 ? "PM" : "AM";
      h = h % 12; if (h === 0) h = 12;
      return `${pad2(h)}:${pad2(m)} ${ampm}`;
    }

    function normalize360(deg){
      return ((deg % 360) + 360) % 360;
    }

    // 0 at 12 o'clock, clockwise
    function angleFromCenter(cx, cy, x, y) {
      const dx = x - cx;
      const dy = y - cy;
      let deg = Math.atan2(dy, dx) * 180 / Math.PI; // 0 at 3 o'clock
      deg = deg + 90; // 0 at 12
      if (deg < 0) deg += 360;
      return deg;
    }

    // shortest delta between angles
    function shortestDelta(a, b){
      // delta = b - a in [-180, 180]
      let d = b - a;
      d = ((d + 540) % 360) - 180;
      return d;
    }

    // ---------- DOM ----------
    const clock = document.getElementById("clock");
    const hourHand = document.getElementById("hourHand");
    const minuteHand = document.getElementById("minuteHand");
    const secondHand = document.getElementById("secondHand");
    const alarmHand = document.getElementById("alarmHand");

    const digitalNow = document.getElementById("digitalNow");
    const alarmStatus = document.getElementById("alarmStatus");
    const rotText = document.getElementById("rotText");
const alarmStepButtons = document.getElementById("alarmStepButtons");
const alarmStepChallenge = document.getElementById("alarmStepChallenge");

    const globeWrap = document.getElementById("globeWrap");

    const overlay = document.getElementById("overlay");
    const snoozeBtn = document.getElementById("snoozeBtn");
    const stopBtn = document.getElementById("stopBtn");
    const snoozeAnchor = document.getElementById("snoozeAnchor");
    const ansA = document.getElementById("ansA");
const ansB = document.getElementById("ansB");
const submitAns = document.getElementById("submitAns");
const feedbackCard = document.getElementById("feedbackCard");
const feedbackImg = document.getElementById("feedbackImg");
const feedbackText = document.getElementById("feedbackText");

let attempts = 0;


    // ---------- Tick marks inside clock ----------
    (function makeTicks(){
      for (let i = 0; i < 12; i++){
        const t = document.createElement("div");
        t.className = "tick big";
        t.dataset.angle = String(i * 30);
        clock.appendChild(t);
      }
      for (let i = 0; i < 60; i++){
        if (i % 5 === 0) continue;
        const t = document.createElement("div");
        t.className = "tick";
        t.dataset.angle = String(i * 6);
        clock.appendChild(t);
      }
      positionTicks();
      window.addEventListener("resize", positionTicks);
    })();

    function positionTicks(){
      const r = clock.clientWidth / 2;
      const rimPad = 20; // inward because thick border + inner rim
      const ticks = clock.querySelectorAll(".tick");
      ticks.forEach(t => {
        const ang = parseFloat(t.dataset.angle);
        const isBig = t.classList.contains("big");
      const len = isBig ? 20 : 12;

        const dist = r - rimPad - (len / 2);
        t.style.height = `${len}px`;
        t.style.transform =
          `translate(-50%, -50%) rotate(${ang}deg) translate(0, -${dist}px)`;
      });
    }

    // ---------- Alarm state ----------
    let alarmSet = false;
    let alarmTarget = null;     // Date
    let alarmHasRung = false;
    let alarmTimeoutId = null;

function clearAlarmTimer() {
  if (alarmTimeoutId) {
    clearTimeout(alarmTimeoutId);
    alarmTimeoutId = null;
  }
}

// Ceil to the next whole minute (never earlier than the given time)
function ceilToNextMinute(date) {
  const d = new Date(date);
  const before = d.getTime();
  d.setSeconds(0, 0);
  if (d.getTime() < before) d.setMinutes(d.getMinutes() + 1);
  return d;
}

function scheduleAlarm() {
  clearAlarmTimer();
  if (!alarmSet || !alarmTarget || alarmHasRung) return;

  const delay = Math.max(0, alarmTarget.getTime() - Date.now());
  alarmTimeoutId = setTimeout(() => {
    // safety checks
    if (!alarmSet || alarmHasRung) return;
    alarmHasRung = true;
    showAlarmUI();
  }, delay);
}


    // total rotation degrees (can be negative/positive); globe display uses this
    let totalRotationDeg = 0;

    // ---------- WebAudio beep ----------
   // ===== Alarm sound (MP3) with loudness doubling every 5s =====
let audioCtx = null;
let alarmEl = null;
let alarmSource = null;
let alarmGain = null;
let loudTimer = null;

const baseGain = 0.12;   // start volume (0.05‚Äì0.20)
const maxGain  = 4.0;    // safety cap (too high can distort)
let gainMultiplier = 1;

function initAlarmAudio() {
  if (audioCtx) return;

  audioCtx = new (window.AudioContext || window.webkitAudioContext)();

  alarmEl = new Audio("alarmsound.mp3");
  alarmEl.loop = true;
  alarmEl.preload = "auto";

  alarmSource = audioCtx.createMediaElementSource(alarmEl);
  alarmGain = audioCtx.createGain();
  alarmGain.gain.value = baseGain;

  alarmSource.connect(alarmGain).connect(audioCtx.destination);
}

// Unlock audio (browser autoplay rules)
window.addEventListener("pointerdown", () => {
  initAlarmAudio();
  audioCtx.resume?.();
}, { once: true });

function startAlarmSound() {
  initAlarmAudio();
  audioCtx.resume?.();

  gainMultiplier = 1;
  alarmGain.gain.setValueAtTime(baseGain, audioCtx.currentTime);

  alarmEl.currentTime = 0;
  alarmEl.play().catch(()=>{});

  clearInterval(loudTimer);
  loudTimer = setInterval(() => {
    gainMultiplier *= 2;
    const next = Math.min(baseGain * gainMultiplier, maxGain);
    alarmGain.gain.setTargetAtTime(next, audioCtx.currentTime, 0.05);
  }, 5000);
}

function stopAlarmSound() {
  clearInterval(loudTimer);
  loudTimer = null;

  if (alarmEl) {
    alarmEl.pause();
    alarmEl.currentTime = 0;
  }
  if (alarmGain && audioCtx) {
    alarmGain.gain.setValueAtTime(baseGain, audioCtx.currentTime);
  }
}

// Unlock audio on first user gesture (important for autoplay restrictions)
window.addEventListener(
  "pointerdown",
  () => {
    initAlarmAudio();
    audioCtx.resume?.();
  },
  { once: true }
);

function startAlarmSound() {
  initAlarmAudio();
  audioCtx.resume?.();

  // reset ramp
  gainMultiplier = 1;
  alarmGain.gain.setValueAtTime(baseGain, audioCtx.currentTime);

  // start from beginning each ring
  alarmEl.currentTime = 0;
  alarmEl.play().catch(() => {
    // If browser blocks autoplay, user must interact once (pointerdown already set)
  });

  // every 5 seconds, 2x louder
  if (loudTimer) clearInterval(loudTimer);
  loudTimer = setInterval(() => {
    gainMultiplier *= 2;
    const next = Math.min(baseGain * gainMultiplier, maxGain);
    alarmGain.gain.setTargetAtTime(next, audioCtx.currentTime, 0.05);
  }, 5000);
}

function stopAlarmSound() {
  if (loudTimer) clearInterval(loudTimer);
  loudTimer = null;

  if (alarmEl) {
    alarmEl.pause();
    alarmEl.currentTime = 0;
  }

  if (alarmGain && audioCtx) {
    alarmGain.gain.setValueAtTime(baseGain, audioCtx.currentTime);
  }
}

    // ---------- Alarm overlay controls ----------
    function positionSnoozeAtAnchor(){
      const r = snoozeAnchor.getBoundingClientRect();
      const x = r.left + r.width / 2;
      const y = r.top + r.height / 2;

      snoozeBtn.style.display = "block";
      const b = snoozeBtn.getBoundingClientRect();

      snoozeBtn.style.left = `${x - b.width/2}px`;
      snoozeBtn.style.top  = `${y - b.height/2}px`;
    }

   function showAlarmUI(){
  overlay.classList.add("show");
  startAlarmSound();                 // alarm starts ringing
 

  // start with ONLY the buttons visible
  alarmStepButtons.classList.remove("hidden");
  alarmStepChallenge.classList.add("hidden");
 positionSnoozeAtAnchor();
  // reset challenge
  attempts = 0;
  feedbackCard.classList.add("hidden");
  ansA.value = "";
  ansB.value = "";
}

    function hideAlarmUI(){
      overlay.classList.remove("show");
      stopAlarmSound();
      snoozeBtn.style.display = "none";
    }

    // Snooze runs anywhere on the screen, only when close
    function pointerCloseToSnooze(x, y) {
      const r = snoozeBtn.getBoundingClientRect();
      const cx = r.left + r.width / 2;
      const cy = r.top + r.height / 2;
      return Math.hypot(x - cx, y - cy) < 140;
    }

    function clamp(v, min, max) { return Math.max(min, Math.min(max, v)); }

    function moveSnoozeAnywhere(awayX, awayY) {
      const b = snoozeBtn.getBoundingClientRect();
      const pad = 10;

      const maxX = window.innerWidth  - b.width  - pad;
      const maxY = window.innerHeight - b.height - pad;

      const cx = b.left + b.width / 2;
      const cy = b.top  + b.height / 2;

      const dx = cx - awayX;
      const dy = cy - awayY;
      const dist = Math.max(1, Math.hypot(dx, dy));
      const ux = dx / dist;
      const uy = dy / dist;

      let newX = (b.left + ux * 140) + (Math.random() - 0.5) * 420;
      let newY = (b.top  + uy * 120) + (Math.random() - 0.5) * 320;

      newX = clamp(newX, pad, Math.max(pad, maxX));
      newY = clamp(newY, pad, Math.max(pad, maxY));

      snoozeBtn.style.left = `${newX}px`;
      snoozeBtn.style.top  = `${newY}px`;
    }

    function getPointerXY(evt) {
      if (evt.touches && evt.touches[0]) return { x: evt.touches[0].clientX, y: evt.touches[0].clientY };
      return { x: evt.clientX, y: evt.clientY };
    }
    function checkAnswer(){
  const a = parseInt(ansA.value, 10);
  const b = parseInt(ansB.value, 10);

  if (a === 4 && b === 16){
    stopAlarmNow(); // ‚úÖ correct stops alarm
    return;
  }

  // wrong answer
  feedbackCard.classList.remove("hidden");

  if (attempts === 0){
     feedbackImg.src = "worriedcat.png"; 
    feedbackText.textContent = "TRY AGAIN üòæ";
  } else {
    feedbackImg.src = "crycat.png";
    feedbackText.textContent = "YOU FAILED AGAIN üòø";
  }

  attempts++;
}

submitAns.addEventListener("click", checkAnswer);

// allow Enter key
[ansA, ansB].forEach(inp => {
  inp.addEventListener("keydown", (e) => {
    if (e.key === "Enter") checkAnswer();
  });
});

function stopAlarmNow(){
  hideAlarmUI();
  clearAlarmTimer?.(); // if you added the timer fix earlier

  alarmSet = false;
  alarmTarget = null;
  alarmHasRung = false;

  alarmHand.style.display = "none";
  alarmStatus.textContent = "ALARM NOT SET YET üò∫";

  // reset challenge UI for next time
  attempts = 0;
  feedbackCard.classList.add("hidden");
  ansA.value = "";
  ansB.value = "";
}



    window.addEventListener("mousemove", (e) => {
      if (!overlay.classList.contains("show")) return;
      if (snoozeBtn.style.display !== "block") return;
      const p = getPointerXY(e);
      if (pointerCloseToSnooze(p.x, p.y)) moveSnoozeAnywhere(p.x, p.y);
    });

    // Buttons
 stopBtn.addEventListener("click", () => {
  // IMPORTANT: do NOT call hideAlarmUI() or stopAlarmSound() here

  // hide the stop/snooze step
  alarmStepButtons.classList.add("hidden");
  snoozeBtn.style.display = "none";

  // show the coding challenge step
  alarmStepChallenge.classList.remove("hidden");

  // reset challenge UI
  attempts = 0;
  feedbackCard.classList.add("hidden");
  ansA.value = "";
  ansB.value = "";
  ansA.focus();
});


  snoozeBtn.addEventListener("click", () => {
  hideAlarmUI();

  alarmSet = true;
  alarmHasRung = false;

  const fiveMinLater = new Date(Date.now() + 5 * 60 * 1000);
  alarmTarget = ceilToNextMinute(fiveMinLater); // snap to minute, never early

  alarmStatus.textContent = `ALARM SET FOR ${formatAlarm12h(alarmTarget)} üòº`;
  alarmHand.style.display = "block";
  updateAlarmHand();
  scheduleAlarm();
});

    // ---------- Globe spin -> set alarm ----------
    let globeDragging = false;
    let dragStartAngle = 0;
    let dragStartRotation = 0;

    function globeCenter(){
      const r = globeWrap.getBoundingClientRect();
      return { cx: r.left + r.width/2, cy: r.top + r.height/2 };
    }

    function onGlobeDown(evt){
      globeDragging = true;
      const p = getPointerXY(evt);
      const {cx, cy} = globeCenter();
      dragStartAngle = angleFromCenter(cx, cy, p.x, p.y);
      dragStartRotation = totalRotationDeg;
      evt.preventDefault?.();
    }

    function onGlobeMove(evt){
      if (!globeDragging) return;
      const p = getPointerXY(evt);
      const {cx, cy} = globeCenter();
      const ang = angleFromCenter(cx, cy, p.x, p.y);
      const d = shortestDelta(dragStartAngle, ang);
      totalRotationDeg = dragStartRotation + d;

      applyGlobeRotation(totalRotationDeg);
      setAlarmFromRotation(totalRotationDeg);
      evt.preventDefault?.();
    }

    function onGlobeUp(){
      globeDragging = false;
    }

    globeWrap.addEventListener("mousedown", onGlobeDown);
    window.addEventListener("mousemove", onGlobeMove);
    window.addEventListener("mouseup", onGlobeUp);

    globeWrap.addEventListener("touchstart", onGlobeDown, { passive:false });
    window.addEventListener("touchmove", onGlobeMove, { passive:false });
    window.addEventListener("touchend", onGlobeUp);

    function applyGlobeRotation(deg){
      globeWrap.style.transform = `rotate(${deg}deg)`;
      rotText.textContent = `${deg.toFixed(1)}¬∞`;
    }

    function setAlarmFromRotation(deg){
  const n = normalize360(deg);
  let minutesOffset = Math.round(n * 4); // 0.25¬∞ = 1 min
  minutesOffset = minutesOffset % 1440;

  const base = ceilToNextMinute(new Date()); // <-- key: minute boundary
  alarmTarget = new Date(base.getTime() + minutesOffset * 60 * 1000);

  alarmSet = true;
  alarmHasRung = false;

  alarmStatus.textContent = `ALARM SET FOR ${formatAlarm12h(alarmTarget)} üòº`;
  alarmHand.style.display = "block";
  updateAlarmHand();
  scheduleAlarm(); // <-- key: schedule exact ring time
}


    // ---------- Clock update (real time) ----------
    function updateClockHands(){
      const d = new Date();

      // digital current time
      digitalNow.textContent = format12h(d);

      // seconds (smooth-ish)
      const sec = d.getSeconds() + d.getMilliseconds()/1000;
      const secDeg = sec * 6;

      // minutes
      const min = d.getMinutes() + sec/60;
      const minDeg = min * 6;

      // hours
      const hour = (d.getHours() % 12) + min/60;
      const hourDeg = hour * 30;

      secondHand.style.transform = `translate(-50%, -92%) rotate(${secDeg}deg)`;
      minuteHand.style.transform = `translate(-50%, -92%) rotate(${minDeg}deg)`;
      hourHand.style.transform   = `translate(-50%, -92%) rotate(${hourDeg}deg)`;

      // check alarm ring
      if (alarmSet && alarmTarget && !alarmHasRung && !overlay.classList.contains("show")){
        if (Date.now() >= alarmTarget.getTime()){
          alarmHasRung = true;
          showAlarmUI();
        }
      }
    }

    function updateAlarmHand(){
      if (!alarmSet || !alarmTarget) return;

      const h = alarmTarget.getHours() % 12;
      const m = alarmTarget.getMinutes();
      const alarmDeg = (h + m/60) * 30; // like hour-hand style pointer
      alarmHand.style.transform = `translate(-50%, -92%) rotate(${alarmDeg}deg)`;
    }
    function stopAlarmForReal(){
  hideAlarmUI();
  clearAlarmTimer?.();

  alarmSet = false;
  alarmTarget = null;
  alarmHasRung = false;

  alarmHand.style.display = "none";
  alarmStatus.textContent = "ALARM NOT SET YET üò∫";
}
function checkAnswer(){
  const a = parseInt(ansA.value, 10);
  const b = parseInt(ansB.value, 10);

  if (a === 4 && b === 16){
    stopAlarmForReal();   // ‚úÖ correct stops alarm
    return;
  }

  feedbackCard.classList.remove("hidden");

  if (attempts === 0){
    feedbackImg.src = "worriedcat.png";
    feedbackText.textContent = "TRY AGAIN üòæ";
  } else {
    feedbackImg.src = "crycat.png";
    feedbackText.textContent = "YOU FAILED AGAIN üòø";
  }

  attempts++;
}
submitAns.addEventListener("click", checkAnswer);

[ansA, ansB].forEach(inp => {
  inp.addEventListener("keydown", (e) => {
    if (e.key === "Enter") checkAnswer();
  });
});


    // Init
    applyGlobeRotation(0);
    updateClockHands();
    setInterval(() => {
      updateClockHands();
      if (alarmSet) updateAlarmHand();
    }, 60);
  </script>
</body>
</html>
